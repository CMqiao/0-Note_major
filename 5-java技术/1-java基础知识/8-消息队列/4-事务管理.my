<div class="blog_title" style="-webkit-text-stroke-width:0px; margin-bottom:15px; text-align:left">
<h3 style="margin-left:0px; margin-right:0px"><span style="font-size:12px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><a href="http://elim.iteye.com/blog/1983532" style="color:#7d0000; text-decoration:underline">Spring整合JMS（四）&mdash;&mdash;事务管理</a></span></span></h3>

<ul style="list-style-type:none">
	<li><span style="font-size:12px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><strong>博客分类：</strong>&nbsp;</span></span></li>
	<li style="list-style-type:none"><span style="font-size:12px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><a href="http://elim.iteye.com/category/156657" style="color:#7d0000; text-decoration:underline">Spring</a></span></span></li>
	<li style="list-style-type:none"><span style="font-size:12px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><a href="http://elim.iteye.com/category/347649" style="color:#7d0000; text-decoration:underline">Jms</a></span></span></li>
</ul>

<div class="news_tag" style="margin-bottom:5px; margin-left:0px; margin-right:0px; margin-top:10px"><span style="font-size:12px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><a href="http://www.iteye.com/blogs/tag/Spring" style="color:#ffffff; text-decoration:none; display:inline-block; margin:0px 5px 5px 0px; padding:0px 10px; border-radius:10px; background-color:#aab5c3">Spring</a><a href="http://www.iteye.com/blogs/tag/JMS" style="color:#ffffff; text-decoration:none; display:inline-block; margin:0px 5px 5px 0px; padding:0px 10px; border-radius:10px; background-color:#aab5c3">JMS</a><a href="http://www.iteye.com/blogs/tag/%E4%BA%8B%E5%8A%A1" style="color:#ffffff; text-decoration:none; display:inline-block; margin:0px 5px 5px 0px; padding:0px 10px; border-radius:10px; background-color:#aab5c3">事务</a><a href="http://www.iteye.com/blogs/tag/sessionTransacted" style="color:#ffffff; text-decoration:none; display:inline-block; margin:0px 5px 5px 0px; padding:0px 10px; border-radius:10px; background-color:#aab5c3">sessionTransacted</a><a href="http://www.iteye.com/blogs/tag/JtaTransactionManager" style="color:#ffffff; text-decoration:none; display:inline-block; margin:0px 5px 5px 0px; padding:0px 10px; border-radius:10px; background-color:#aab5c3">JtaTransactionManager</a>&nbsp;</span></span></div>
</div>

<div class="blog_content" id="blog_content" style="-webkit-text-stroke-width:0px; text-align:left">
<div class="iteye-blog-content-contain">
<h2 style="margin-left:28.8pt; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></h2>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">提供了一个</span><span style="font-family:Calibri">JmsTransactionManager</span><span style="font-family:宋体">用于对</span><span style="font-family:Calibri">JMS ConnectionFactory</span><span style="font-family:宋体">做事务管理。这将允许</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">应用利用</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">的事务管理特性。</span><span style="font-family:Calibri">JmsTransactionManager</span><span style="font-family:宋体">在执行本地资源事务管理时将从指定的</span><span style="font-family:Calibri">ConnectionFactory</span><span style="font-family:宋体">绑定一个</span><span style="font-family:Calibri">ConnectionFactory/Session</span><span style="font-family:宋体">这样的配对到线程中。</span><span style="font-family:Calibri">JmsTemplate</span><span style="font-family:宋体">会自动检测这样的事务资源，并对它们进行相应操作。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">在</span><span style="font-family:Calibri">Java EE</span><span style="font-family:宋体">环境中，</span><span style="font-family:Calibri">ConnectionFactory</span><span style="font-family:宋体">会池化</span><span style="font-family:Calibri">Connection</span><span style="font-family:宋体">和</span><span style="font-family:Calibri">Session</span><span style="font-family:宋体">，这样这些资源将会在整个事务中被有效地重复利用。在一个独立的环境中，使用</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">的</span><span style="font-family:Calibri">SingleConnectionFactory</span><span style="font-family:宋体">时所有的事务将公用一个</span><span style="font-family:Calibri">Connection</span><span style="font-family:宋体">，但是每个事务将保留自己独立的</span><span style="font-family:Calibri">Session</span><span style="font-family:宋体">。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:Calibri">JmsTemplate</span><span style="font-family:宋体">可以利用</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">和能够进行分布式的</span><span style="font-family:Calibri">&nbsp;JMS ConnectionFactory</span><span style="font-family:宋体">处理分布式事务。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">在</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">整合</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">的应用中，如果我们要进行本地的事务管理的话非常简单，只需要在定义对应的消息监听容器时指定其</span><span style="font-family:Calibri">sessionTransacted</span><span style="font-family:宋体">属性为</span><span style="font-family:Calibri">true</span><span style="font-family:宋体">，如：</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Xml代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>bean</strong>&nbsp;id=&quot;jmsContainer&quot;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;class=&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot;<strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;connectionFactory&quot;&nbsp;ref=&quot;connectionFactory&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;destination&quot;&nbsp;ref=&quot;queueDestination&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;messageListener&quot;&nbsp;ref=&quot;consumerMessageListener&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;sessionTransacted&quot;&nbsp;value=&quot;true&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;/</strong><strong>bean</strong><strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">该属性值默认为</span><span style="font-family:Calibri">false</span><span style="font-family:宋体">，这样</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">在进行消息监听的时候就会进行事务控制，当在接收消息时监听器执行失败时</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">就会对接收到的消息进行回滚，对于</span><span style="font-family:Calibri">SessionAwareMessageListener</span><span style="font-family:宋体">在接收到消息后发送一个返回消息时也处于同一事务下，但是对于其他操作如数据库访问等将不属于该事务控制。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">这里我们可以来做一个这样的测试：我们如上配置监听在</span><span style="font-family:Calibri">queueDestination</span><span style="font-family:宋体">的消息监听容器的</span><span style="font-family:Calibri">sessionTransacted</span><span style="font-family:宋体">属性为</span><span style="font-family:Calibri">true</span><span style="font-family:宋体">，然后把我们前面提到的消息监听器</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">改成这样：</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Java代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>public</strong>&nbsp;<strong>class</strong>&nbsp;ConsumerMessageListener&nbsp;<strong>implements</strong>&nbsp;MessageListener&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>public</strong>&nbsp;<strong>void</strong>&nbsp;onMessage(Message&nbsp;message)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这里我们知道生产者发送的就是一个纯文本消息，所以这里可以直接进行强制转换，或者直接把onMessage方法的参数改成Message的子类TextMessage&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextMessage&nbsp;textMsg&nbsp;=&nbsp;(TextMessage)&nbsp;message;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;接收到一个纯文本消息。&quot;);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>try</strong>&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;消息内容是：&quot;&nbsp;+&nbsp;textMsg.getText());&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>if</strong>&nbsp;(1&nbsp;==&nbsp;1)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>throw</strong>&nbsp;<strong>new</strong>&nbsp;RuntimeException(&quot;Error&quot;);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<strong>catch</strong>&nbsp;(JMSException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">}&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">我们可以看到在上述代码中我们的</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">在进行消息接收的时候抛出了一个</span><span style="font-family:Calibri">RuntimeException</span><span style="font-family:宋体">，根据我们上面说的，因为我们已经在对应的监听容器上定义了其</span><span style="font-family:Calibri">sessionTransacted</span><span style="font-family:宋体">属性为</span><span style="font-family:Calibri">true</span><span style="font-family:宋体">，所以当这里抛出异常的时候</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">将对接收到的消息进行回滚，即下次进行消息接收的时候该消息仍然能够被接收到。为了验证这一点，我们先执行一遍测试代码，往</span><span style="font-family:Calibri">queueDestination</span><span style="font-family:宋体">发送一个文本消息，这个时候</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">在进行接收的时候将会抛出一个</span><span style="font-family:Calibri">RuntimeException</span><span style="font-family:宋体">，已经接收到的纯文本消息将进行回滚；接着我们去掉上面代码中抛出异常的语句，即</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">能够正常的进行消息接收，这个时候我们再运行一次测试代码，往</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">监听的</span><span style="font-family:Calibri">queueDestination</span><span style="font-family:宋体">发送一条消息。如果之前在接手时抛出了异常的那条消息已经回滚了的话，那么这个时候将能够接收到两条消息，控制台将输出接收到的两条消息的内容。具体结果有兴趣的朋友可以自己验证一下。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">如果想接收消息和数据库访问处于同一事务中，那么我们就可以配置一个外部的事务管理同时配置一个支持外部事务管理的消息监听容器（如</span><span style="font-family:Calibri">DefaultMessageListenerContainer</span><span style="font-family:宋体">）。要配置这样一个参与分布式事务管理的消息监听容器，我们可以配置一个</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">，当然底层的</span><span style="font-family:Calibri">JMS ConnectionFactory</span><span style="font-family:宋体">需要能够支持分布式事务管理，并正确地注册我们的</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">。这样消息监听器进行消息接收和对应的数据库访问就会处于同一数据库控制下，当消息接收失败或数据库访问失败都会进行事务回滚操作。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Xml代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>bean</strong>&nbsp;id=&quot;jmsContainer&quot;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;class=&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot;<strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;connectionFactory&quot;&nbsp;ref=&quot;connectionFactory&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;destination&quot;&nbsp;ref=&quot;queueDestination&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;messageListener&quot;&nbsp;ref=&quot;consumerMessageListener&quot;&nbsp;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;transactionManager&quot;&nbsp;ref=&quot;jtaTransactionManager&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;/</strong><strong>bean</strong><strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>bean</strong>&nbsp;id=&quot;jtaTransactionManager&quot;&nbsp;class=&quot;org.springframework.transaction.jta.JtaTransactionManager&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">当给消息监听容器指定了</span><span style="font-family:Calibri">transactionManager</span><span style="font-family:宋体">时，消息监听容器将忽略</span><span style="font-family:Calibri">sessionTransacted</span><span style="font-family:宋体">的值。</span></span>&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">关于使用</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">来管理上述分布式事务，我们这里也可以来做一个试验。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">首先：往</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">配置文件</span><span style="font-family:Calibri">applicationContext.xml</span><span style="font-family:宋体">中添加如下配置：</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Xml代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>bean</strong>&nbsp;id=&quot;jdbcTemplate&quot;&nbsp;class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;<strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>&lt;</strong><strong>property</strong>&nbsp;name=&quot;dataSource&quot;&nbsp;ref=&quot;dataSource&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;/</strong><strong>bean</strong><strong>&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>jee:jndi-lookup</strong>&nbsp;jndi-name=&quot;jdbc/mysql&quot;&nbsp;id=&quot;dataSource&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>bean</strong>&nbsp;id=&quot;jtaTransactionManager&quot;&nbsp;class=&quot;org.springframework.transaction.jta.JtaTransactionManager&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>&lt;</strong><strong>tx:annotation-driven</strong>&nbsp;transaction-manager=&quot;jtaTransactionManager&quot;<strong>/&gt;</strong>&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">我们可以看到，在这里我们引入了一个</span><span style="font-family:Calibri">jndi</span><span style="font-family:宋体">数据源，定义了一个</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">，定义了</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">基于注解的声明式事务管理，定义了一个</span><span style="font-family:Calibri">Spring</span><span style="font-family:宋体">提供的进行</span><span style="font-family:Calibri">Jdbc</span><span style="font-family:宋体">操作的工具类</span><span style="font-family:Calibri">jdbcTemplate</span><span style="font-family:宋体">。</span></span></span></span></span></p>

<p><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px">&nbsp;</span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">接下来把我们的</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">改为如下形式：</span></span></span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Java代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>public</strong>&nbsp;<strong>class</strong>&nbsp;ConsumerMessageListener&nbsp;<strong>implements</strong>&nbsp;MessageListener&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>private</strong>&nbsp;TestDao&nbsp;testDao;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>private</strong>&nbsp;<strong>int</strong>&nbsp;count&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>public</strong>&nbsp;<strong>void</strong>&nbsp;onMessage(Message&nbsp;message)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这里我们知道生产者发送的就是一个纯文本消息，所以这里可以直接进行强制转换，或者直接把onMessage方法的参数改成Message的子类TextMessage&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextMessage&nbsp;textMsg&nbsp;=&nbsp;(TextMessage)&nbsp;message;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<strong>new</strong>&nbsp;Date().toLocaleString()&nbsp;+&nbsp;&quot;接收到一个纯文本消息。&quot;);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>try</strong>&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;text&nbsp;=&nbsp;textMsg.getText();&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;消息内容是：&quot;&nbsp;+&nbsp;text);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;当前count的值是：&quot;&nbsp;+&nbsp;count);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testDao.insert(text&nbsp;+&nbsp;count);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>if</strong>&nbsp;(count&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;++;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>throw</strong>&nbsp;<strong>new</strong>&nbsp;RuntimeException(&quot;Error!&nbsp;出错啦！&quot;);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<strong>catch</strong>&nbsp;(JMSException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">}&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:宋体">我们可以看到，在</span><span style="font-family:Calibri">ConsumerMessageListener</span><span style="font-family:宋体">中我们定义了一个实例变量</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">，其初始值为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">；在</span><span style="font-family:Calibri">onMessage</span><span style="font-family:宋体">里面，我们可以看到我们把接收到的消息内容作为参数调用了</span><span style="font-family:Calibri">testDao</span><span style="font-family:宋体">的</span><span style="font-family:Calibri">insert</span><span style="font-family:宋体">方法；当</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">值为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">，也就是进行第一次消息接收的时候会将</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">的值加</span><span style="font-family:Calibri">1</span><span style="font-family:宋体">，同时抛出一个运行时异常。那么我们这里要测试的就是进行第一次接收的时候</span><span style="font-family:Calibri">testDao</span><span style="font-family:宋体">已经把相关内容插入数据库了，接着在</span><span style="font-family:Calibri">onMessage</span><span style="font-family:宋体">里面抛出了一个异常同时</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">加</span><span style="font-family:Calibri">1</span><span style="font-family:宋体">，我们预期的结果应该是此时数据库进行回滚，同时</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">也回滚，这样</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">将继续尝试接收该消息，此时同样会调用</span><span style="font-family:Calibri">testDao</span><span style="font-family:宋体">的</span><span style="font-family:Calibri">insert</span><span style="font-family:宋体">方法将内容插入数据库，再接着</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">已经不为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">了，所以此时将不再抛出异常，</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">成功进行消息的接收，</span><span style="font-family:Calibri">testDao</span><span style="font-family:宋体">也成功的将消息内容插入到了数据库。要证明这个预期我们除了看数据库中插入的数据外，还可以看控制台的输出，正常情况控制台将输出两次消息接收的内容，且第一次时</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">，第二次</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">为</span><span style="font-family:Calibri">1</span><span style="font-family:宋体">。</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:Calibri">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TestDao</span><span style="font-family:宋体">是一个接口，其</span><span style="font-family:Calibri">TestDaoImpl</span><span style="font-family:宋体">对</span><span style="font-family:Calibri">insert</span><span style="font-family:宋体">的方法实现如下：</span></span>&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Java代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">@Transactional(readOnly=<strong>false</strong>)&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>public</strong>&nbsp;<strong>void</strong>&nbsp;insert(<strong>final</strong>&nbsp;String&nbsp;name)&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;jdbcTemplate.update(&quot;insert&nbsp;into&nbsp;test(name)&nbsp;values(?)&quot;,&nbsp;name);&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">}&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">这里我们使用支持</span><span style="font-family:Calibri">JtaTransactionManager</span><span style="font-family:宋体">的</span><span style="font-family:Calibri">Weblogic</span><span style="font-family:宋体">来进行测试，因为是</span><span style="font-family:Calibri">Web</span><span style="font-family:宋体">容器，所以我们这里定义了一个</span><span style="font-family:Calibri">Controller</span><span style="font-family:宋体">来进行消息的发送，具体代码如下：</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;</span></span></span></p>

<div class="iteye-blog-content-contain">
<div class="dp-highlighter" id="" style="margin-left:9px; padding:1px; width:679px">
<div class="bar">
<div class="tools" style="padding:3px; text-align:left"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>Java代码&nbsp;<embed allowscriptaccess="always" height="15" pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="http://elim.iteye.com/javascripts/syntaxhighlighter/clipboard_new.swf" type="application/x-shockwave-flash" width="14" wmode="transparent"></embed>&nbsp;<a href="javascript:void()" onclick="code_favorites_do_favorite(this);return false;" style="color:#7d0000; text-decoration:underline" title="收藏这段代码"><img alt="收藏代码" class="star" src="http://elim.iteye.com/images/icon_star.png" style="border:0px" /></a></strong></span></span></span></span></span></span></div>
</div>

<ol start="1" style="margin-left:0px; margin-right:0px">
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">@Controller&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">@RequestMapping(&quot;test&quot;)&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"><strong>public</strong>&nbsp;<strong>class</strong>&nbsp;TestController&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier(&quot;queueDestination&quot;)&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>private</strong>&nbsp;Destination&nbsp;destination;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>private</strong>&nbsp;ProducerService&nbsp;producerService;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;@RequestMapping(&quot;first&quot;)&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;<strong>public</strong>&nbsp;String&nbsp;first()&nbsp;{&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;producerService.sendMessage(destination,&nbsp;&quot;你好，现在是：&quot;&nbsp;+&nbsp;<strong>new</strong>&nbsp;Date().toLocaleString());&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>return</strong>&nbsp;&quot;/test/first&quot;;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></span></span></span></li>
	<li><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><span style="font-size:12px"><span style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace">}&nbsp;&nbsp;</span></span></span></span></span></span></li>
</ol>
</div>
</div>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:宋体">接下来就是启用</span><span style="font-family:Calibri">Weblogic</span><span style="font-family:宋体">服务器，进入其控制台，定义一个名叫&ldquo;</span><span style="font-family:Calibri">jdbc/mysql</span><span style="font-family:宋体">&rdquo;的</span><span style="font-family:Calibri">JNDI</span><span style="font-family:宋体">数据源，然后把该项目部署到</span><span style="font-family:Calibri">Weblogic</span><span style="font-family:宋体">服务器上并进行启动。接下来我们就可以访问</span><span style="font-family:Calibri">/test/first.do</span><span style="font-family:宋体">访问到上述</span><span style="font-family:Calibri">first</span><span style="font-family:宋体">方法。之后控制台会输出如下信息：</span></span></span></span></span></p>

<p style="margin-left:0cm; margin-right:0cm"><br />
<span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:medium"><span style="font-family:Calibri"><img alt="" src="http://dl2.iteye.com/upload/attachment/0091/7448/655db0fd-c363-3ebb-9165-9e3c59515307.png" style="border:0px" /><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family:宋体">我们可以看到当</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">时接收了一次，并随后抛出了异常，之后</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">为</span><span style="font-family:Calibri">1</span><span style="font-family:宋体">又接收了一次，这说明在</span><span style="font-family:Calibri">count</span><span style="font-family:宋体">为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">时抛出异常后我们的</span><span style="font-family:Calibri">JMS</span><span style="font-family:宋体">进行回滚了，那么我们的数据库是否有进行回滚呢？接着我们来看数据库中的内容：</span></span></span></span></span></p>

<p><br />
<span style="font-size:14px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif"><span style="font-size:14px"><span style="font-size:14px"><img alt="" src="http://dl2.iteye.com/upload/attachment/0091/7450/7196d8b4-8947-3ca9-aee2-c0831cc15061.png" style="border:0px" /><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-size:12pt"><span style="font-family:宋体">我们可以看到数据库表中只有一条记录，而且最后一位表示</span></span>count<span style="font-size:12pt"><span style="font-family:宋体">的值的为</span></span>1<span style="font-size:12pt"><span style="font-family:宋体">，这说明在</span></span>JMS<span style="font-size:12pt"><span style="font-family:宋体">进行消息接收抛出异常时我们的数据库也回滚了。关于使用</span></span>JtaTransactionManager<span style="font-size:12pt"><span style="font-family:宋体">进行分布式事务管理的问题就说到这里了，有兴趣的朋友可以自己试验一下。</span></span></span></span></span></span></p>
</div>
</div>
